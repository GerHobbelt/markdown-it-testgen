{"version":3,"file":"markdownTestGen.umd.js","sources":["../index.js"],"sourcesContent":["\nlet fs      = require('fs');\nlet p       = require('path');\n\nlet yaml    = require('js-yaml');\n\n\nfunction _class(obj) {\n  return Object.prototype.toString.call(obj);\n}\n\nfunction isString(obj)   {\n  return _class(obj) === '[object String]';\n}\nfunction isFunction(obj) {\n  return _class(obj) === '[object Function]';\n}\nfunction isArray(obj)    {\n  return _class(obj) === '[object Array]';\n}\n\n\nfunction fixLF(str) {\n  return str.length ? str + '\\n' : str;\n}\n\n\nfunction parse(input, options) {\n  let lines = input.split(/\\r?\\n/g);\n  let max = lines.length;\n  let min = 0;\n  let line = 0;\n  let fixture, i, l, currentSep, blockStart;\n\n  let result = {\n    fixtures: []\n  };\n\n  let sep = options.sep || [ '.' ];\n\n  // Try to parse meta\n  if (/^-{3,}$/.test(lines[0] || '')) {\n    line++;\n    while (line < max && !/^-{3,}$/.test(lines[line])) {\n      line++;\n    }\n\n    // If meta end found - extract range\n    if (line < max) {\n      result.meta = lines.slice(1, line).join('\\n');\n      line++;\n      min = line;\n    } else {\n      // if no meta closing - reset to start and try to parse data without meta\n      line = 1;\n    }\n  }\n\n  // Scan fixtures\n  while (line < max) {\n    if (sep.indexOf(lines[line]) < 0) {\n      line++;\n      continue;\n    }\n\n    currentSep = lines[line];\n\n    fixture = {\n      type: currentSep,\n      header: '',\n      first: {\n        text: '',\n        range: []\n      },\n      second: {\n        text: '',\n        range: []\n      }\n    };\n\n    line++;\n    blockStart = line;\n\n    // seek end of first block\n    while (line < max && lines[line] !== currentSep) {\n      line++;\n    }\n    if (line >= max) {\n      break;\n    }\n\n    fixture.first.text = fixLF(lines.slice(blockStart, line).join('\\n'));\n    fixture.first.range.push(blockStart, line);\n    line++;\n    blockStart = line;\n\n    // seek end of second block\n    while (line < max && lines[line] !== currentSep) {\n      line++;\n    }\n    if (line >= max) {\n      break;\n    }\n\n    fixture.second.text = fixLF(lines.slice(blockStart, line).join('\\n'));\n    fixture.second.range.push(blockStart, line);\n    line++;\n\n    // Look back for header on 2 lines before texture blocks\n    i = fixture.first.range[0] - 2;\n    while (i >= Math.max(min, fixture.first.range[0] - 3)) {\n      l = lines[i];\n      if (sep.indexOf(l) >= 0) {\n        break;\n      }\n      if (l.trim().length) {\n        fixture.header = l.trim();\n        break;\n      }\n      i--;\n    }\n\n    result.fixtures.push(fixture);\n  }\n\n  return (result.meta || result.fixtures.length) ? result : null;\n}\n\n\n// Read fixtures recursively, and run iterator on parsed content\n//\n// Options\n//\n// - sep (String|Array) - allowed fixture separator(s)\n//\n// Parsed data fields:\n//\n// - file (String): file name\n// - meta (Mixed):  metadata from header, if exists\n// - fixtures\n//\nfunction load(path, options, iterator) {\n  let input, parsed,\n      stat = fs.statSync(path);\n\n  if (isFunction(options)) {\n    iterator = options;\n    options = { sep: [ '.' ] };\n  } else if (isString(options)) {\n    options = { sep: options.split('') };\n  } else if (isArray(options)) {\n    options = { sep: options };\n  }\n\n  if (stat.isFile()) {\n    input = fs.readFileSync(path, 'utf8');\n\n    parsed = parse(input, options);\n\n    if (!parsed) {\n      return null;\n    }\n\n    parsed.file = path;\n    try {\n      let src = parsed.meta || '';\n      if (src.trim() === '') {\n        parsed.meta = null;\n      } else {\n        parsed.meta = yaml.safeLoad(src);\n      }\n    } catch (ex) {\n      console.error('markdon-it-testgen: META parse error:', ex);\n      parsed.meta = null;\n    }\n\n    if (iterator) {\n      iterator(parsed);\n    }\n    return parsed;\n  }\n\n  let result, res;\n  if (stat.isDirectory()) {\n    result = [];\n\n    fs.readdirSync(path).forEach(function (name) {\n      res = load(p.join(path, name), options, iterator);\n      if (Array.isArray(res)) {\n        result = result.concat(res);\n      } else if (res) {\n        result.push(res);\n      }\n    });\n\n    return result;\n  }\n\n  // Silently ignore other entries (symlinks and so on)\n  return null;\n}\n\nfunction generate(path, options, md, env) {\n  if (!md && options.render) {\n    md = options;\n    options = {};\n  }\n\n  env = env || {};\n\n  options = Object.assign({}, options);\n  options.assert = options.assert || require('assert');\n\n  load(path, options, function (data) {\n    data.meta = Object.assign({}, data.meta);\n\n    // options.desc wins over metadata, which itself wins over the path-based description generator calls in here:\n    let desc = '' + (options.desc || data.meta.desc || p.relative(path, data.file) || p.basename(data.file));\n    // ^ the result is cast to a string as meta.desc MAY be a number of other implicit type originating from\n    //   the YAML parser, e.g. `desc: 123` in your YAML would produce a *number* rather than a *string*.\n    options.assert.strictEqual(typeof desc, 'string', 'every test series is expected to come with a decent title');\n    options.assert(desc.length > 0, 'every test series is expected to come with a decent *non-empty* title');\n\n    (data.meta.skip ? describe.skip : describe)(desc, function () {\n      data.fixtures.forEach(function (fixture) {\n        let testTitle = fixture.header && options.header ? fixture.header : 'line ' + (fixture.first.range[0] - 1);\n        if (options.test) {\n          options.test(it, testTitle, fixture, options, md, Object.assign({}, env));\n        } else {\n          it(testTitle, function () {\n            options.assert.strictEqual(md.render(fixture.first.text, Object.assign({}, env)), fixture.second.text);\n          });\n        }\n      });\n    });\n  });\n}\n\nmodule.exports = generate;\nmodule.exports.load = load;\n"],"names":["fs","require","p","yaml","_class","obj","Object","prototype","toString","call","isString","isFunction","isArray","fixLF","str","length","parse","input","options","lines","split","max","min","line","fixture","i","l","currentSep","blockStart","result","fixtures","sep","test","meta","slice","join","indexOf","type","header","first","text","range","second","push","Math","trim","load","path","iterator","parsed","stat","statSync","isFile","readFileSync","file","src","safeLoad","ex","console","error","res","isDirectory","readdirSync","forEach","name","Array","concat","generate","md","env","render","assign","assert","data","desc","relative","basename","strictEqual","skip","describe","testTitle","it","module","exports"],"mappings":"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"}